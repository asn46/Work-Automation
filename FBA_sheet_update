import gspread
from oauth2client.service_account import ServiceAccountCredentials
from freshdesk.v2.api import API

#--------------------------------------------------------------------


def FBA_ticket_check():
    a = API('fabhabitat2021.freshdesk.com', hidden.api_key)
    scope = ['https://www.googleapis.com/auth/spreadsheets', 'https://www.googleapis.com/auth/drive.file', 'https://www.googleapis.com/auth/drive']
    creds = ServiceAccountCredentials.from_json_keyfile_name(hidden.api_key_path, scope)
    client = gspread.authorize(creds)

    update = None
    
    for ticket in a.tickets.list_tickets():
        
        fullstring = str(ticket)
        
        if 'FBA Inbound Shipment' in fullstring and not 'Bill of Lading' in fullstring:
            condition = 1
        else:
            condition = 0
        
        if condition == 1:
            FBA_number =  fullstring[fullstring.find("(")+1 : fullstring.rfind(")")]
            substring1 = 'FBA Inbound Shipment Checked-In'
            substring2 = 'FBA Inbound Shipment Receiving'
            substring3 = 'FBA Inbound Shipment Received In-Full'
            
            if substring1 in fullstring:
                update = 'Reached FBA'
            elif substring2 in fullstring:
                update = 'Being Received'
            elif substring3 in fullstring:
                update = 'Closed'
            else:
                break
                print('There was an error.')
        
            sheet = client.open('python_test').sheet1
            x = sheet.find(f'{FBA_number}')
            sheet.update_cell(x.row, x.col+2, f'{update}')  
            
            print('FBA sheet updated')
        
        else:
            pass
            

FBA_ticket_check()
        
        
